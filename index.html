<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ </title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- LIFF SDK -->
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background:#f4f6f8;}
    .container{max-width:340px;margin:0 auto;padding:24px;}
    .card{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08);padding:24px;position:relative;}
    h2{margin:0 0 24px;font-size:18px;text-align:center;}
    .close-btn{position:absolute;top:12px;right:12px;border:none;background:transparent;font-size:20px;cursor:pointer;display:none;}
    label{display:block;margin:0 0 12px;font-size:14px;font-weight:600;}
    input,select{width:100%;padding:10px;border:1px solid #e0e0e0;border-radius:6px;background:#eee;font-size:15px;}
    .submit-btn{margin-top:24px;width:100%;padding:14px 0;border:none;border-radius:8px;font-size:15px;font-weight:700;color:#fff;background:#00C300;cursor:pointer;transition:opacity .2s;}
    .submit-btn:disabled{opacity:.5;cursor:not-allowed;}
    .policy-link{display:block;margin-top:8px;font-size:12px;color:#0056ff;text-decoration:underline;}
    .spinner-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .spinner {
      border: 6px solid #eee;
      border-top: 6px solid #00C300;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0%   { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
    .complete-message {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }
    .complete-content {
      background: #fff;
      border-radius: 16px;
      padding: 32px 24px;
      text-align: center;
      min-width: 260px;
      max-width: 90vw;
      margin-left: 16px;
      margin-right: 16px;
    }
    @media (max-width: 480px) {
      .complete-content {
        padding: 24px 8vw;
        margin-left: 4vw;
        margin-right: 4vw;
      }
    }
    .complete-title {
      font-size: 1.5em;
      font-weight: bold;
      margin-bottom: 16px;
    }
    .complete-detail {
      font-size: 1em;
      margin-bottom: 8px;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <button class="close-btn" aria-label="é–‰ã˜ã‚‹">âœ•</button>
      <h2>äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ  ver7</h2>
      <div id="loadingSpinner" class="spinner-overlay" style="display:none;">
        <div class="spinner"></div>
      </div>
      <div id="completeMessage" class="complete-message" style="display:none;">
        <div class="complete-content">
          <div class="complete-title">äºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸï¼</div>
          <div id="completeDetail" class="complete-detail"></div>
          <button id="completeOkBtn" class="submit-btn" style="margin-top:24px;">OK</button>
        </div>
      </div>
      <form id="reserveForm">
        <label>æ°å
          <input type="text" name="name" placeholder="å±±ç”° èŠ±å­" required>
        </label>
        <label>å­¦æ ¡å
          <input type="text" name="school" placeholder="ã€‡ã€‡é«˜æ ¡" required>
        </label>
        <label>å­¦å¹´
          <select name="grade" required>
            <option value="" hidden disabled selected>é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="1">1å¹´</option>
            <option value="2">2å¹´</option>
            <option value="3">3å¹´</option>
          </select>
        </label>
        <a href="https://example.com/privacy" target="_blank" class="policy-link">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã«ã¤ã„ã¦</a>
        <button class="submit-btn" type="submit" id="submitBtn">
          ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã«<br>åŒæ„ã—ã¦äºˆç´„ã™ã‚‹
        </button>
      </form>
    </div>
  </div>
  <script>
    // API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®šæ•°
    //const API_ENDPOINT = 'https://homepc.gamebox777.work/api/miniapp-api/reservations';
    const API_ENDPOINT = 'https://port7071.gamebox777.work/api/miniapp-api/reservations';

    // LIFFè¨­å®š
    const LIFF_ID = '2007366489-ZaL835MB'; // å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  (Full)
    const ENABLE_TEST_MODE = false; // æœ¬ç•ªç”¨è¨­å®š
    
    // LIFFåˆæœŸåŒ–çŠ¶æ…‹ç®¡ç†
    let liffReady = false;

    // LIFFåˆæœŸåŒ–
    async function initializeLiff() {
      try {
        await liff.init({ liffId: LIFF_ID });
        liffReady = true;
        console.log('LIFFåˆæœŸåŒ–å®Œäº†');
        
        // åˆæœŸåŒ–å®Œäº†å¾Œã«ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
        const submitBtn = document.getElementById('submitBtn');
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã«\nåŒæ„ã—ã¦äºˆç´„ã™ã‚‹';
        }
      } catch (error) {
        console.log('LIFFåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        liffReady = false;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      // åˆæœŸçŠ¶æ…‹ã§ã¯ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      const submitBtn = document.getElementById('submitBtn');
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = 'LIFFåˆæœŸåŒ–ä¸­...<br>ãŠå¾…ã¡ãã ã•ã„';
      }
      
      // LIFFåˆæœŸåŒ–ã‚’å®Ÿè¡Œ
      initializeLiff();
    });
    
    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰tokenã‚’å–å¾—ã—hiddenã§ã‚»ãƒƒãƒˆ
    const p     = new URLSearchParams(location.search);
    const token = p.get('tok') ?? '';
    document.addEventListener('DOMContentLoaded', () => {
      const tokenInput = document.createElement('input');
      tokenInput.type = 'hidden';
      tokenInput.name = 'token';
      tokenInput.value = token;
      document.getElementById('reserveForm').appendChild(tokenInput);
    });
    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
    const form   = document.getElementById('reserveForm');
    const button = document.getElementById('submitBtn');
    const spinner = document.getElementById('loadingSpinner');
    const completeMessage = document.getElementById('completeMessage');
    const completeDetail = document.getElementById('completeDetail');
    const completeOkBtn = document.getElementById('completeOkBtn');
    form.addEventListener('submit', async e => {
      e.preventDefault();
      button.disabled = true;
      spinner.style.display = 'flex'; // ã‚¹ãƒ”ãƒŠãƒ¼è¡¨ç¤º
      const startTime = Date.now();
      console.log('é€ä¿¡ãƒœã‚¿ãƒ³æŠ¼ä¸‹:', new Date(startTime).toISOString());
      try {
        const body = {
          name   : form.name.value.trim(),
          school : form.school.value.trim(),
          grade  : form.grade.value,
          token  : token
        };

        let debugLog = '';
        debugLog += '[é€ä¿¡ãƒ‡ãƒ¼ã‚¿]\n' + JSON.stringify(body, null, 2) + '\n\n';

        const response = await fetch(API_ENDPOINT, {
          method : 'POST',
          headers: { 'Content-Type': 'application/json' },
          body   : JSON.stringify(body)
        });

        const endTime = Date.now();
        const elapsed = ((endTime - startTime) / 1000).toFixed(2);
        console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡:', new Date(endTime).toISOString());
        console.log('APIå¿œç­”æ™‚é–“:', elapsed + 'ç§’');

        debugLog += '[ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹]\n' + response.status + '\n';

        let responseText = '';
        try {
          responseText = await response.text();
          debugLog += '[ãƒ¬ã‚¹ãƒãƒ³ã‚¹å†…å®¹]\n' + responseText + '\n';
        } catch (e) {
          debugLog += '[ãƒ¬ã‚¹ãƒãƒ³ã‚¹å†…å®¹å–å¾—ã‚¨ãƒ©ãƒ¼]\n' + e.message + '\n';
        }

        if (!response.ok) {
          throw new Error(`API ã‚¨ãƒ©ãƒ¼: ${response.status} - ${responseText}`);
        }

        completeDetail.textContent = 'APIå¿œç­”æ™‚é–“: ' + elapsed + 'ç§’\näºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ãƒˆãƒ¼ã‚¯ç”»é¢ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ä¸­...';
        completeMessage.style.display = 'flex';
        
        // LINEãƒˆãƒ¼ã‚¯ç”»é¢ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
        console.log('LIFFçŠ¶æ…‹ãƒã‚§ãƒƒã‚¯:');
        console.log('- liffå®šç¾©æ¸ˆã¿:', typeof liff !== 'undefined');
        console.log('- liffReady ãƒ•ãƒ©ã‚°:', liffReady);
        console.log('- LIFFåˆæœŸåŒ–æ¸ˆã¿:', liffReady && liff.isReady && liff.isReady());
        console.log('- LINEã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå†…:', liffReady && liff.isInClient && liff.isInClient());
        
        try {
          if (liffReady && liff.isReady && liff.isReady()) {
            if (liff.isInClient()) {
              console.log('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡é–‹å§‹...');
              await liff.sendMessages([
                {
                  type: 'text',
                  text: `ğŸ‰ äºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸï¼\n\nğŸ“ äºˆç´„å†…å®¹\nãƒ»æ°å: ${body.name}\nãƒ»å­¦æ ¡å: ${body.school}\nãƒ»å­¦å¹´: ${body.grade}å¹´\n\nâ±ï¸ APIå¿œç­”æ™‚é–“: ${elapsed}ç§’\n\nã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼`
                }
              ]);
              console.log('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å®Œäº†');
              completeDetail.textContent = 'APIå¿œç­”æ™‚é–“: ' + elapsed + 'ç§’\nãƒˆãƒ¼ã‚¯ç”»é¢ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ã‚¢ãƒ—ãƒªã‚’è‡ªå‹•ã§é–‰ã˜ã¾ã™...';
            } else {
              console.log('LINEã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå¤–ç’°å¢ƒã§ã™');
              completeDetail.textContent = 'APIå¿œç­”æ™‚é–“: ' + elapsed + 'ç§’\näºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ï¼ˆLINEã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå¤–ç’°å¢ƒï¼‰';
            }
          } else {
            console.log('LIFFæœªåˆæœŸåŒ–çŠ¶æ…‹');
            completeDetail.textContent = 'APIå¿œç­”æ™‚é–“: ' + elapsed + 'ç§’\näºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ï¼ˆLIFFåˆæœŸåŒ–å¾…æ©Ÿä¸­ï¼‰';
          }
        } catch (messageError) {
          console.log('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚¨ãƒ©ãƒ¼:', messageError);
          completeDetail.textContent = 'APIå¿œç­”æ™‚é–“: ' + elapsed + 'ç§’\näºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚¨ãƒ©ãƒ¼: ' + messageError.message + 'ï¼‰';
        }
        
        // 3ç§’å¾Œã«LIFFã‚¢ãƒ—ãƒªã‚’è‡ªå‹•ã§é–‰ã˜ã‚‹ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æ™‚é–“ã‚’è€ƒæ…®ï¼‰
        setTimeout(() => {
          try {
            if (liffReady && liff.isInClient()) {
              liff.closeWindow();
            } else {
              // LIFFç’°å¢ƒã§ãªã„å ´åˆã®ä»£æ›¿å‡¦ç†
              console.log('LIFFç’°å¢ƒã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆè‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºãªã—ï¼‰');
            }
          } catch (error) {
            console.log('ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚¯ãƒ­ãƒ¼ã‚ºã‚¨ãƒ©ãƒ¼:', error);
          }
        }, 3000);
      } catch(err){
        let errorMessage = 'é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\n';
        errorMessage += '[ã‚¨ãƒ©ãƒ¼å]\n' + (err.name || '') + '\n';
        errorMessage += '[ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸]\n' + (err.message || '') + '\n';
        errorMessage += '[ã‚¨ãƒ©ãƒ¼ã‚¹ã‚¿ãƒƒã‚¯]\n' + (err.stack || '') + '\n\n';
        if (typeof debugLog !== 'undefined') {
          errorMessage += debugLog;
        }
        errorMessage += '\næ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
        alert(errorMessage);
        button.disabled = false;
      }
      spinner.style.display = 'none'; // ã‚¹ãƒ”ãƒŠãƒ¼éè¡¨ç¤º
    });
    completeOkBtn.addEventListener('click', () => {
      try {
        if (liffReady && liff.isInClient()) {
          liff.closeWindow();
        } else {
          completeMessage.style.display = 'none';
        }
      } catch (error) {
        console.log('ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚¯ãƒ­ãƒ¼ã‚ºã‚¨ãƒ©ãƒ¼:', error);
        completeMessage.style.display = 'none';
      }
    });
  </script>
</body>
</html>
