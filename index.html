<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>‰∫àÁ¥Ñ„Éï„Ç©„Éº„É†</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- LIFF SDK -->
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background:#f4f6f8;}
    .container{max-width:340px;margin:0 auto;padding:24px;}
    .card{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08);padding:24px;position:relative;}
    h2{margin:0 0 24px;font-size:18px;text-align:center;}
    .close-btn{position:absolute;top:12px;right:12px;border:none;background:transparent;font-size:20px;cursor:pointer;display:none;}
    label{display:block;margin:0 0 12px;font-size:14px;font-weight:600;}
    input,select{width:100%;padding:10px;border:1px solid #e0e0e0;border-radius:6px;background:#eee;font-size:15px;}
    .submit-btn{margin-top:24px;width:100%;padding:14px 0;border:none;border-radius:8px;font-size:15px;font-weight:700;color:#fff;background:#00C300;cursor:pointer;transition:opacity .2s;}
    .submit-btn:disabled{opacity:.5;cursor:not-allowed;}
    .policy-link{display:block;margin-top:8px;font-size:12px;color:#0056ff;text-decoration:underline;}
    .spinner-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .spinner {
      border: 6px solid #eee;
      border-top: 6px solid #00C300;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0%   { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
    .complete-message {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }
    .complete-content {
      background: #fff;
      border-radius: 16px;
      padding: 32px 24px;
      text-align: center;
      min-width: 260px;
      max-width: 90vw;
      margin-left: 16px;
      margin-right: 16px;
    }
    @media (max-width: 480px) {
      .complete-content {
        padding: 24px 8vw;
        margin-left: 4vw;
        margin-right: 4vw;
      }
    }
    .complete-title {
      font-size: 1.5em;
      font-weight: bold;
      margin-bottom: 16px;
    }
    .complete-detail {
      font-size: 1em;
      margin-bottom: 8px;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <button class="close-btn" aria-label="Èñâ„Åò„Çã">‚úï</button>
      <h2>‰∫àÁ¥Ñ„Éï„Ç©„Éº„É† ver6</h2>
      <div id="loadingSpinner" class="spinner-overlay" style="display:none;">
        <div class="spinner"></div>
      </div>
      <div id="completeMessage" class="complete-message" style="display:none;">
        <div class="complete-content">
          <div class="complete-title">‰∫àÁ¥Ñ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ</div>
          <div id="completeDetail" class="complete-detail"></div>
          <button id="completeOkBtn" class="submit-btn" style="margin-top:24px;">OK</button>
        </div>
      </div>
      <form id="reserveForm">
        <label>Ê∞èÂêç
          <input type="text" name="name" placeholder="Â±±Áî∞ Ëä±Â≠ê" required>
        </label>
        <label>Â≠¶Ê†°Âêç
          <input type="text" name="school" placeholder="„Äá„ÄáÈ´òÊ†°" required>
        </label>
        <label>Â≠¶Âπ¥
          <select name="grade" required>
            <option value="" hidden disabled selected>ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
            <option value="1">1Âπ¥</option>
            <option value="2">2Âπ¥</option>
            <option value="3">3Âπ¥</option>
          </select>
        </label>
        <a href="https://example.com/privacy" target="_blank" class="policy-link">„Éó„É©„Ç§„Éê„Ç∑„Éº„Éù„É™„Ç∑„Éº„Å´„Å§„ÅÑ„Å¶</a>
        <button class="submit-btn" type="submit" id="submitBtn">
          „Éó„É©„Ç§„Éê„Ç∑„Éº„Éù„É™„Ç∑„Éº„Å´<br>ÂêåÊÑè„Åó„Å¶‰∫àÁ¥Ñ„Åô„Çã
        </button>
      </form>
    </div>
  </div>
  <script>
    // API „Ç®„É≥„Éâ„Éù„Ç§„É≥„ÉàÂÆöÊï∞
    //const API_ENDPOINT = 'https://homepc.gamebox777.work/api/miniapp-api/reservations';
    const API_ENDPOINT = 'https://port7071.gamebox777.work/api/miniapp-api/reservations';

    // LIFFË®≠ÂÆö
    const LIFF_ID = '2007366489-ZaL835MB'; // ÂÖ•Âäõ„Éï„Ç©„Éº„É† (Full)
    const ENABLE_TEST_MODE = false; // Êú¨Áï™Áî®Ë®≠ÂÆö

    // LIFFÂàùÊúüÂåñ
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        if (LIFF_ID !== 'YOUR_LIFF_ID') {
          await liff.init({ liffId: LIFF_ID });
          console.log('LIFFÂàùÊúüÂåñÂÆå‰∫Ü');
        } else {
          console.log('‚ö†Ô∏è LIFF ID„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇLIFF_IDÂ§âÊï∞„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        }
      } catch (error) {
        console.log('LIFFÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
      }
    });
    
    // URL„Éë„É©„É°„Éº„Çø„Åã„Çâtoken„ÇíÂèñÂæó„Åóhidden„Åß„Çª„ÉÉ„Éà
    const p     = new URLSearchParams(location.search);
    const token = p.get('tok') ?? '';
    document.addEventListener('DOMContentLoaded', () => {
      const tokenInput = document.createElement('input');
      tokenInput.type = 'hidden';
      tokenInput.name = 'token';
      tokenInput.value = token;
      document.getElementById('reserveForm').appendChild(tokenInput);
    });
    // „Éï„Ç©„Éº„É†ÈÄÅ‰ø°
    const form   = document.getElementById('reserveForm');
    const button = document.getElementById('submitBtn');
    const spinner = document.getElementById('loadingSpinner');
    const completeMessage = document.getElementById('completeMessage');
    const completeDetail = document.getElementById('completeDetail');
    const completeOkBtn = document.getElementById('completeOkBtn');
    form.addEventListener('submit', async e => {
      e.preventDefault();
      button.disabled = true;
      spinner.style.display = 'flex'; // „Çπ„Éî„Éä„ÉºË°®Á§∫
      const startTime = Date.now();
      console.log('ÈÄÅ‰ø°„Éú„Çø„É≥Êäº‰∏ã:', new Date(startTime).toISOString());
      try {
        const body = {
          name   : form.name.value.trim(),
          school : form.school.value.trim(),
          grade  : form.grade.value,
          token  : token
        };

        let debugLog = '';
        debugLog += '[ÈÄÅ‰ø°„Éá„Éº„Çø]\n' + JSON.stringify(body, null, 2) + '\n\n';

        const response = await fetch(API_ENDPOINT, {
          method : 'POST',
          headers: { 'Content-Type': 'application/json' },
          body   : JSON.stringify(body)
        });

        const endTime = Date.now();
        const elapsed = ((endTime - startTime) / 1000).toFixed(2);
        console.log('„É¨„Çπ„Éù„É≥„ÇπÂèó‰ø°:', new Date(endTime).toISOString());
        console.log('APIÂøúÁ≠îÊôÇÈñì:', elapsed + 'Áßí');

        debugLog += '[„É¨„Çπ„Éù„É≥„Çπ„Çπ„ÉÜ„Éº„Çø„Çπ]\n' + response.status + '\n';

        let responseText = '';
        try {
          responseText = await response.text();
          debugLog += '[„É¨„Çπ„Éù„É≥„ÇπÂÜÖÂÆπ]\n' + responseText + '\n';
        } catch (e) {
          debugLog += '[„É¨„Çπ„Éù„É≥„ÇπÂÜÖÂÆπÂèñÂæó„Ç®„É©„Éº]\n' + e.message + '\n';
        }

        if (!response.ok) {
          throw new Error(`API „Ç®„É©„Éº: ${response.status} - ${responseText}`);
        }

        completeDetail.textContent = 'APIÂøúÁ≠îÊôÇÈñì: ' + elapsed + 'Áßí\n‰∫àÁ¥Ñ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ„Éà„Éº„ÇØÁîªÈù¢„Å´„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°‰∏≠...';
        completeMessage.style.display = 'flex';
        
        // LINE„Éà„Éº„ÇØÁîªÈù¢„Å´„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°
        console.log('LIFFÁä∂ÊÖã„ÉÅ„Çß„ÉÉ„ÇØ:');
        console.log('- liffÂÆöÁæ©Ê∏à„Åø:', typeof liff !== 'undefined');
        console.log('- LIFFÂàùÊúüÂåñÊ∏à„Åø:', typeof liff !== 'undefined' && liff.isReady && liff.isReady());
        console.log('- LINE„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÂÜÖ:', typeof liff !== 'undefined' && liff.isInClient && liff.isInClient());
        
        try {
          if (typeof liff !== 'undefined' && liff.isReady && liff.isReady()) {
            if (liff.isInClient()) {
              console.log('„É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°ÈñãÂßã...');
              await liff.sendMessages([
                {
                  type: 'text',
                  text: `üéâ ‰∫àÁ¥Ñ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ\n\nüìù ‰∫àÁ¥ÑÂÜÖÂÆπ\n„ÉªÊ∞èÂêç: ${body.name}\n„ÉªÂ≠¶Ê†°Âêç: ${body.school}\n„ÉªÂ≠¶Âπ¥: ${body.grade}Âπ¥\n\n‚è±Ô∏è APIÂøúÁ≠îÊôÇÈñì: ${elapsed}Áßí\n\n„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åó„ÅüÔºÅ`
                }
              ]);
              console.log('„É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°ÂÆå‰∫Ü');
              completeDetail.textContent = 'APIÂøúÁ≠îÊôÇÈñì: ' + elapsed + 'Áßí\n„Éà„Éº„ÇØÁîªÈù¢„Å´„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü„ÄÇ„Ç¢„Éó„É™„ÇíËá™Âãï„ÅßÈñâ„Åò„Åæ„Åô...';
            } else {
              console.log('LINE„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÂ§ñÁí∞Â¢É„Åß„Åô');
              if (ENABLE_TEST_MODE) {
                console.log('„ÉÜ„Çπ„Éà„É¢„Éº„Éâ: „É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°„ÇíË©¶Ë°å„Åó„Åæ„Åô');
                await liff.sendMessages([
                  {
                    type: 'text',
                    text: `üéâ ‰∫àÁ¥Ñ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ\n\nüìù ‰∫àÁ¥ÑÂÜÖÂÆπ\n„ÉªÊ∞èÂêç: ${body.name}\n„ÉªÂ≠¶Ê†°Âêç: ${body.school}\n„ÉªÂ≠¶Âπ¥: ${body.grade}Âπ¥\n\n‚è±Ô∏è APIÂøúÁ≠îÊôÇÈñì: ${elapsed}Áßí\n\n„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åó„ÅüÔºÅ`
                  }
                ]);
                completeDetail.textContent = 'APIÂøúÁ≠îÊôÇÈñì: ' + elapsed + 'Áßí\n[„ÉÜ„Çπ„Éà„É¢„Éº„Éâ] „É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°„ÇíË©¶Ë°å„Åó„Åæ„Åó„Åü„ÄÇ';
              } else {
                completeDetail.textContent = 'APIÂøúÁ≠îÊôÇÈñì: ' + elapsed + 'Áßí\n‰∫àÁ¥Ñ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇÔºàLINE„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÂ§ñ„ÅÆ„Åü„ÇÅ„ÄÅ„É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°„Å™„ÅóÔºâ';
              }
            }
          } else {
            console.log('LIFFÊú™ÂàùÊúüÂåñ„Åæ„Åü„ÅØSDKÊú™Ë™≠„ÅøËæº„Åø');
            completeDetail.textContent = 'APIÂøúÁ≠îÊôÇÈñì: ' + elapsed + 'Áßí\n‰∫àÁ¥Ñ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇÔºàLIFFÊú™ÂàùÊúüÂåñÔºâ';
          }
        } catch (messageError) {
          console.log('„É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°„Ç®„É©„Éº:', messageError);
          completeDetail.textContent = 'APIÂøúÁ≠îÊôÇÈñì: ' + elapsed + 'Áßí\n‰∫àÁ¥Ñ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇÔºà„É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°„Ç®„É©„Éº: ' + messageError.message + 'Ôºâ';
        }
        
        // 3ÁßíÂæå„Å´LIFF„Ç¢„Éó„É™„ÇíËá™Âãï„ÅßÈñâ„Åò„ÇãÔºà„É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°ÊôÇÈñì„ÇíËÄÉÊÖÆÔºâ
        setTimeout(() => {
          try {
            if (typeof liff !== 'undefined' && liff.isInClient()) {
              liff.closeWindow();
            } else {
              // LIFFÁí∞Â¢É„Åß„Å™„ÅÑÂ†¥Âêà„ÅÆ‰ª£ÊõøÂá¶ÁêÜ
              console.log('LIFFÁí∞Â¢É„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì');
            }
          } catch (error) {
            console.log('„Ç¶„Ç£„É≥„Éâ„Ç¶„ÇØ„É≠„Éº„Ç∫„Ç®„É©„Éº:', error);
          }
        }, 3000);
      } catch(err){
        let errorMessage = 'ÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ\n\n';
        errorMessage += '[„Ç®„É©„ÉºÂêç]\n' + (err.name || '') + '\n';
        errorMessage += '[„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏]\n' + (err.message || '') + '\n';
        errorMessage += '[„Ç®„É©„Éº„Çπ„Çø„ÉÉ„ÇØ]\n' + (err.stack || '') + '\n\n';
        if (typeof debugLog !== 'undefined') {
          errorMessage += debugLog;
        }
        errorMessage += '\nÊôÇÈñì„Çí„Åä„ÅÑ„Å¶ÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ';
        alert(errorMessage);
        button.disabled = false;
      }
      spinner.style.display = 'none'; // „Çπ„Éî„Éä„ÉºÈùûË°®Á§∫
    });
    completeOkBtn.addEventListener('click', () => {
      try {
        if (typeof liff !== 'undefined' && liff.isInClient()) {
          liff.closeWindow();
        } else {
          completeMessage.style.display = 'none';
        }
      } catch (error) {
        console.log('„Ç¶„Ç£„É≥„Éâ„Ç¶„ÇØ„É≠„Éº„Ç∫„Ç®„É©„Éº:', error);
        completeMessage.style.display = 'none';
      }
    });
  </script>
</body>
</html>
